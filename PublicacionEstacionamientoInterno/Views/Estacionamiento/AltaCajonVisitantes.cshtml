
@{
    //ViewBag.Title = "AltaCajonVisitantes";
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Cajones Visitantes</title>
    <link href="~/Content/Site.css" rel="stylesheet" type="text/css" />
    <link href="~/Content/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <script src="~/Scripts/modernizr-2.6.2.js"></script>
    <link href="~/alertifyjs/css/alertify.css" rel="stylesheet" />
    <link href="~/alertifyjs/css/themes/default.min.css" rel="stylesheet" />
    <link href="~/FontAwesome/css/all.css" rel="stylesheet" />
</head>

<body>
    <style>
        th,
        td {
            vertical-align: text-top;
            text-align: center;
        }

        th {
            vertical-align: bottom;
            color: white;
        }


        /* Fixed Headers */

        th {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 2;
            background-color: #1A5276;
        }

            th[scope=row] {
                position: -webkit-sticky;
                position: sticky;
                left: 0;
                z-index: 1;
            }

            th[scope=row] {
                vertical-align: top;
            }

        table:nth-of-type(2) th:not([scope=row]):first-child {
            left: 0;
            z-index: 3;
        }

        /* Strictly for making the scrolling happen. */

        th[scope=row] + td {
            min-width: 24em;
        }

        th[scope=row] {
            min-width: 20em;
        }

        .divScroll {
            /* definir una altura pequeña para forzar el scroll */
            height: 300px;
            overflow-y: scroll;
        }

        .divScrollOne {
            overflow-x: scroll;
        }

        ::-webkit-scrollbar {
            width: 10px;
            background-color: transparent;
        }

        ::-webkit-scrollbar-track {
            -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
            background-color: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background-color: #1A5276;
            -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.5);
            /*background-image: -webkit-linear-gradient(90deg,transparent,rgba(0, 0, 0, 0.4) 50%,transparent,transparent)*/
            /*background-image: -webkit-linear-gradient(90deg,rgba(255, 255, 255, .2) 25%,transparent 25%,transparent 50%,rgba(255, 255, 255, .2) 50%,rgba(255, 255, 255, .2) 75%,transparent 75%,transparent)*/
        }

        /*Desactivar las flechas en campo tipo number*/
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>

    <div class="navbar navbar-inverse navbar-fixed-top" style="background:-webkit-linear-gradient(#7FB3D5 ,#2471A3); border-color:white">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                @*@Html.ActionLink("Application name", "Index", "Home", new { area = "" }, new { @class = "navbar-brand" })*@
            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav"></ul>
            </div>
        </div>
    </div>

    <h2 style="color:#283747; text-align:center; font-weight:bold">SOLICITUD CAJÓN A VISITANTES </h2>
    <br />
    <br />

    <div class="container" style="text-align:center">
        <div class="row">
            <div class="col-md-6">
                <button class="btn btn-success" id="btnConsultarSolicitud" style="background-color:white; border:3px solid #D35400"><b style="font-size:20px; color:black">Consultar Solicitud <span class="fas fa-folder-open"></span></b></button>
            </div>
            <div class="col-md-6">
                <button class="btn btn-success" id="btnGenerarSolicitud" style="background-color:white; border:3px solid #D35400"><b style="font-size:20px; color:black">Generar Solicitud <span class="fas fa-clipboard-check"></span></b></button>
            </div>
        </div>
    </div>


    <div class="container collapse" id="divAsignacionesLugarVisitantes">
        <br />
        <div class="row">
            <div class="col-md-4">
                <b style="font-size:20px; color:gray"><span class="fas fa-user-tie fa-1x" style="color:#1A5276"></span>Nombre del Visitante:</b><br /><br />
                <b style="font-size:20px; color:gray"><span class="far fa-calendar-alt fa-1x" style="color:#1A5276"></span> Fecha de Visita:</b><br /><br />
                <b style="font-size:20px; color:gray"><span class="far fa-clock fa-1x" style="color:#1A5276"></span> Hora de Entrada:</b><br /><br />
                <b style="font-size:20px; color:gray"><span class="far fa-clock fa-1x" style="color:#1A5276"></span> Hora de Salida:</b><br /><br />
            </div>
            <div class="col-md-4">
                <input type="text" id="nombreVisita" class="form-control" /><br />
                <input type="date" class="form-control" id="fechaVisita" /><br />
                <input type="time" class="form-control" id="horaEntrada" /><br />
                <input type="time" class="form-control" id="horaSalida" /><br />
            </div>
            <div class="col-md-4">
                <b style="font-size:20px; color:gray"><span class="fas fa-plus-circle fa-1x" style="color:#1A5276"></span> No. de Empleado Solicitante</b><br />
                <input type="number" class="form-control" id="noEmpleadoSolicita" />
                <div class="collapse" id="divNombreEmpleado">
                    <b style="font-size:20px; color:gray"><span class="fas fa-user fa-1x" style="color:#1A5276"></span> Nombre de Empleado</b><br />
                    @Html.TextArea("nombreEmpleadoVisita", new { @class = "form-control", @id = "nombreEmpleadoVisita", @disabled = "disabled" })

                    <b style="font-size:20px; color:gray"><span class="far fa-envelope fa-1x" style="color:#1A5276"></span> Correo de Empleado</b><br />
                    <input type="text" class="form-control" id="correoEmpleadoVisita" disabled="disabled" />
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-4">
                <b style="font-size:20px; color:gray"><span class="far fa-id-card fa-1x" style="color:#1A5276"></span> Placa:</b><br /><br />
                <b style="font-size:20px; color:gray"><span class="fas fa-car-side fa-1x" style="color:#1A5276"></span> Modelo:</b><br /><br />
                <b style="font-size:20px; color:gray"><span class="fas fa-car-alt fa-1x" style="color:#1A5276"></span> Color:</b><br /><br />
            </div>
            <div class="col-md-4">
                <input type="text" class="form-control" id="placa" /><br />
                <input type="text" class="form-control" id="modelo" /><br />
                <input type="text" class="form-control" id="color" /><br />
            </div>
            <div class="col-md-4">
                <b style="font-size:20px; color:gray"><span class="fas fa-eye fa-1x" style="color:#1A5276"></span> Observaciones:</b><br /><br />
                @Html.TextArea("observacionesEstacionamientoVisita", null, new { @class = "form-control", @id = "observacionesEstaVisita" })
            </div>
        </div><br />

        <div style="text-align:center">
            <button class="btn btn-success" id="btnAsignarLugarVisitante"><b style="font-size:20px; color:black">Mandar Solicitud <span class="fas fa-user-plus"></span></b></button>
        </div>
    </div>

    <div class="container collapse" id="divConsultaSolicitud">
        <br />
        <div class="row">
            <div class="col-md-4">
                <h3>Ingresa tu número de Solicitud</h3>
            </div>
            <div class="col-md-4">
                <br />
                <input type="number" class="form-control" id="numeroSeguimiento" />
            </div>
            <div class="col-md-4">
                <br />
                <button class="btn btn-success" id="btnConsultarSolicitudProceso"><b style="font-size:20px; color:black">Consultar <span class="far fa-folder-open"></span></b></button>
            </div>
        </div>
    </div>


    <div class="collapse container" id="divTablaVisitantes">
        <br />
        <table class="table" style="border: 2px solid #34495E; text-align:center" id="tableVisitantesEstacionamiento">
            <thead>
                <tr>
                    <th><b>Dirección</b></th>
                    <th><b>Lugar</b></th>
                    <th><b>Usuario</b></th>
                    <th><b>Usuario Responsable</b></th>
                    <th><b>Hora Entrada</b></th>
                    <th><b>Hora Salida</b></th>
                    <th><b>Placas</b></th>
                    <th><b>Modelo</b></th>
                    <th><b>Color</b></th>
                    <th><b>Fecha Visita</b></th>
                    <th><b>Observaciones</b></th>
                </tr>
            </thead>

            <tbody id="tbodyVisitantesEstacionamiento">
                @*<tr>
                        <td>Dirección/td>
                        <td>Lugar</td>
                        <td>Rol</td>
                        <td>Fecha Asignación</td>
                        <td>Observaciones</td>
                    </tr>*@
            </tbody>
        </table>
    </div>


    <script src="~/scripts/jquery-1.10.2.js"></script>
    <script src="~/alertifyjs/alertify.js"></script>
    <script>

        function Limpiar() {
            $("#nombreVisita").val("");
            $("#fechaVisita").val("");
            $("#horaEntrada").val("");
            $("#horaSalida").val("");
            $("#observacionesEstaVisita").val("");
            $("#placa").val("");
            $("#modelo").val("");
            $("#color").val("");
            $("#noEmpleadoSolicita").val("");
            $("#nombreEmpleadoVisita").val("");
            $("#correoEmpleadoVisita").val("");
        };

        function MostrarEstacionamientosVisitas(lista) {
            debugger;
            var filas = "";

            $.each(lista, function (i, estaciona) {
                debugger;

                filas += '<tr style="border-bottom: 2px solid #34495E"><td><p>' + estaciona.Lugares.sLugar + '</p></td><td><p>' + estaciona.LugarDireccion.sLugar + '</p></td><td><p>' + estaciona.Usuarios.sNombre + '</p></td><td><p>' + estaciona.Usuarios.nombreResponsable + '</p></td><td><p>' + estaciona.horaVisita + '</p></td><td><p>' + estaciona.horaSalida + '</p></td><td><p>' + estaciona.sPlaca + '</p></td><td><p>' + estaciona.sModelo + '</p></td><td><p>' + estaciona.sColor + '</p></td><td><p>' + estaciona.dtFechaVisitaJSON + '</p></td><td><p>' + estaciona.sObservaciones + '</p></td></tr>';

            });

            $("#tbodyVisitantesEstacionamiento").empty();
            $("#tbodyVisitantesEstacionamiento").html(filas);
            $("#divTablaVisitantes").show();
            debugger;
        };

        $(document).ready(function () {

            $("#btnConsultarSolicitud").click(function () {

                $("#divAsignacionesLugarVisitantes").hide();
                $("#divConsultaSolicitud").show();
                $("#divTablaVisitantes").hide();
                $("#numeroSeguimiento").val("");
            });

            $("#btnGenerarSolicitud").click(function () {

                $("#divAsignacionesLugarVisitantes").show();
                $("#divConsultaSolicitud").hide();
                $("#divTablaVisitantes").hide();
            });

            $("#noEmpleadoSolicita").focus(function () {

                $("#noEmpleadoSolicita").val("");
            });

            $("#noEmpleadoSolicita").focusout(function () {

                var parametroBusqueda = $("#noEmpleadoSolicita").val();
                debugger;

                if (parametroBusqueda == "") {
                    alertify.error("No ha ingresado un número de empleado");
                }
                else {
                    $.ajax({

                         url: "/Estacionamiento/BuscarUserAD_AJAX?parametroBusqueda=" + parametroBusqueda,
                        type: "GET",
                        contentType: "application/json;charset=utf-8",
                        dataType: "JSON",
                        cache: false,

                        success: function (r) {

                            if (r.error == true) {
                                var alert = alertify.alert("Error", r.mensaje).set('label', 'Aceptar');
                                alert.set({ transition: 'zoom' }); //slide, zoom, flipx, flipy, fade, pulse (default)
                                alert.set('modal', false);  //al pulsar fuera del dialog se cierra o no
                                $("#txtParametroUser").val("");
                                $("#btnBuscarUser").prop("disabled", false);
                                $("#gifCargando").hide();
                            }
                            else {

                                $("#divNombreEmpleado").show();

                                $("#nombreEmpleadoVisita").val(r.Usuario.sNombre);
                                $("#correoEmpleadoVisita").val(r.Usuario.sCorreo);
                                $("#noEmpleadoSolicita").css("border", "");
                                debugger;
                            }

                        },

                        error: function (error) {
                            alert(error.responseText);
                        }

                    });
                }


            });

            $("#noEmpleadoSolicita").keypress(function (e) {

                if (e.which == 13) {

                    var parametroBusqueda = $("#noEmpleadoSolicita").val();
                    debugger;

                    $.ajax({

                         url: "/Estacionamiento/BuscarUserAD_AJAX?parametroBusqueda=" + parametroBusqueda,
                        type: "GET",
                        contentType: "application/json;charset=utf-8",
                        dataType: "JSON",
                        cache: false,

                        success: function (r) {

                            if (r.error == true) {
                                var alert = alertify.alert("Error", r.mensaje).set('label', 'Aceptar');
                                alert.set({ transition: 'zoom' }); //slide, zoom, flipx, flipy, fade, pulse (default)
                                alert.set('modal', false);  //al pulsar fuera del dialog se cierra o no
                                $("#txtParametroUser").val("");
                                $("#btnBuscarUser").prop("disabled", false);
                                $("#gifCargando").hide();
                            }
                            else {

                                $("#divNombreEmpleado").show();

                                $("#nombreEmpleadoVisita").val(r.Usuario.sNombre);
                                $("#correoEmpleadoVisita").val(r.Usuario.sCorreo);
                                $("#noEmpleadoSolicita").css("border", "");
                                debugger;
                            }

                        },

                        error: function (error) {
                            alert(error.responseText);
                        }

                    });

                }

            });

            $("#fechaVisita").focusout(function () {

                var fechaVisitaHoy = $("#fechaVisita").val();
                debugger;

                $.ajax({

                     url: "/Estacionamiento/ValidarFechaHoy_AJAX?fecha=" + fechaVisitaHoy,
                    type: "GET",
                    contentType: "application/json;charset=utf-8",
                    dataType: "JSON",
                    cache: false,

                    success: function (r) {
                        if (r.validarFecha == true) {

                            alertify
                                .alert("Los cajones se asigna mínimo un día antes de la Fecha de Visita.", function () {
                                });

                            $("#fechaVisita").css("border", "2px solid red")
                            $("#fechaVisita").val("");
                        }
                        else {
                            $("#fechaVisita").css("border", "")
                        }
                    },

                    error: function (error) {
                        alert(error.responseText);
                    }
                });

            });

            $("#btnAsignarLugarVisitante").click(function () {

                $("#btnAsignarLugarVisitante").prop("disabled", true);

                var hayError = false;
                var textoError = "";

                if ($("#listCatalogoSeleccion").val() == "") {
                    hayError = true;
                    textoError += "Seleccione dirección de Estacionamiento\n";
                    $("#listCatalogoSeleccion").css("border", "2px solid red");
                }
                else {
                    $("#listCatalogoSeleccion").css("border", "");
                }

                if ($("#lugar").val() == "") {
                    hayError = true;
                    textoError += "Ingrese lugar\n";
                    $("#lugar").css("border", "2px solid red");
                }
                else {
                    $("#lugar").css("border", "");
                }


                if ($("#nombreVisita").val() == "") {
                    hayError = true;
                    textoError += "Ingrese nombre de Visitante\n";
                    $("#nombreVisita").css("border", "2px solid red");
                }
                else {
                    $("#nombreVisita").css("border", "");
                }


                if ($("#fechaVisita").val() == "") {
                    hayError = true;
                    textoError += "Ingrese Fecha de Visita\n";
                    $("#fechaVisita").css("border", "2px solid red");
                }
                else {
                    $("#fechaVisita").css("border", "");
                }


                if ($("#horaEntrada").val() == "") {
                    hayError = true;
                    textoError += "Ingrese Hora de Entrada\n";
                    $("#horaEntrada").css("border", "2px solid red");
                }
                else {
                    $("#horaEntrada").css("border", "");
                }


                if ($("#horaSalida").val() == "") {
                    hayError = true;
                    textoError += "Ingrese Hora de Salida\n";
                    $("#horaSalida").css("border", "2px solid red");
                }
                else {
                    $("#horaSalida").css("border", "");
                }


                if ($("#noEmpleadoSolicita").val() == "") {
                    hayError = true;
                    textoError += "Ingrese Número de Empleado que Visita\n";
                    $("#noEmpleadoSolicita").css("border", "2px solid red");
                }
                else {
                    $("#noEmpleadoSolicita").css("border", "");
                }

                if (hayError == true) {

                    alertify.error(textoError);
                    return false;

                    $("#btnAsignarLugarVisitante").prop("disabled", false);

                    debugger;
                }

                $("#nombreEmpleadoVisita").prop("disabled", false);
                $("#correoEmpleadoVisita").prop("disabled", false);

                var objetoEstacionamiento =
                    {
                        iUsuario: $("#noEmpleadoSolicita").val(),
                        nombreUsuario: $("#nombreEmpleadoVisita").val(),
                        correoUsuario: $("#correoEmpleadoVisita").val(),
                        nombreVisitante: $("#nombreVisita").val(),
                        dtFechaVisita: $("#fechaVisita").val(),
                        horaVisita: $("#horaEntrada").val(),
                        horaSalida: $("#horaSalida").val(),
                        sObservaciones: $("#observacionesEstaVisita").val(),
                        sPlaca: $("#placa").val(),
                        sModelo: $("#modelo").val(),
                        sColor: $("#color").val()
                    };

                debugger;

                $.ajax({

                     url: "/Estacionamiento/AsignarEstacionamientoVisitanteUsuario_AJAX",
                    type: "POST",
                    contentType: "application/json;charset=utf-8",
                    dataTYpe: "JSON",
                    data: JSON.stringify(objetoEstacionamiento),
                    cache: false,

                    success: function (r) {
                        if (r.error == true) {
                            var alert = alertify.alert("Error", r.mensaje).set('label', 'Aceptar');
                            alert.set({ transition: 'zoom' }); //slide, zoom, flipx, flipy, fade, pulse (default)
                            alert.set('modal', false);  //al pulsar fuera del dialog se cierra o no
                            $("#btnAsignarLugarVisitante").prop("disabled", false);
                            $("#nombreEmpleadoVisita").prop("disabled", true);
                            $("#correoEmpleadoVisita").prop("disabled", true);

                        }
                        else {

                            $("#nombreEmpleadoVisita").prop("disabled", true);
                            $("#correoEmpleadoVisita").prop("disabled", true);
                            $("#divNombreEmpleado").hide();
                            $("#btnAsignarLugarVisitante").prop("disabled", false);

                            alertify
                                .alert("Solicitud Correcta","Se mandaron tus datos exitosamente, su folio de solicitud es: " + r.registroCajon + ". " + "Revise su correo para más detalles.", function () {
                                    alertify.success('OK');
                                });

                            Limpiar();
                            $("#divNombreEmpleado").hide();

                            debugger;
                        }
                    },

                    error: function (error) {
                        alert(error.responseText);
                    }
                });
            });

            $("#btnConsultarSolicitudProceso").click(function () {

                var solicitud = $("#numeroSeguimiento").val();

                if (solicitud == "") {

                    alertify.error("Ingresa tú número de solicitud");
                }

                else {
                    $.ajax({

                         url: "/Estacionamiento/ComprobarSolicitud_AJAX?solicitud=" + solicitud,
                        type: "GET",
                        contentType: "application/json;charset=utf-8",
                        dataType: "JSON",
                        cache: false,

                        success: function (r) {

                            if (r.error == true) {

                                alertify
                              .alert("Error",r.mensaje, function () {
                              });

                                $("#tbodyVisitantesEstacionamiento").empty();
                                $("#divTablaVisitantes").hide();
                            }
                            else {


                                if (r.listaEstacionamiento.length != 0) {

                                    MostrarEstacionamientosVisitas(r.listaEstacionamiento);

                                    alertify
                                        .alert("Consulta",r.estatus, function () {
                                        });
                                }
                                else {
                                    alertify
                                        .alert("Consulta",r.estatus, function () {
                                        });

                                    $("#tbodyVisitantesEstacionamiento").empty();
                                    $("#divTablaVisitantes").hide();
                                }

                            }

                        },

                        error: function (error) {
                            alert(error.responseText);
                        }

                    });
                }

            });

        });

        //session end
        var sessionTimeoutWarning = @Session.Timeout -1;
        debugger;

        var sTimeout = parseInt(sessionTimeoutWarning) * 60 * 1000;
        setTimeout('SessionEnd()', sTimeout);

        function SessionEnd() {
            //window.location = "/pep/PEPLogin/LoginOut";
            window.location = "/Estacionamiento/AltaCajonVisitantes";
        }
    </script>
</body>
</html>

